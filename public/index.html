<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ODDO BHF Fund Allocation Tool</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #1a3a52;
            --primary-light: #2d5a80;
            --accent: #c9a961;
            --accent-light: #d4b373;
            --bg-light: #f8f9fa;
            --bg-white: #ffffff;
            --text-dark: #2c3e50;
            --text-gray: #6c757d;
            --border-color: #e0e6ed;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --info: #3498db;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f5f7fa;
            color: var(--text-dark);
            line-height: 1.6;
        }

        .navbar {
            background: var(--bg-white);
            border-bottom: 1px solid var(--border-color);
            padding: 1.2rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .navbar-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-family: 'Poppins', sans-serif;
            font-size: 1.4em;
            font-weight: 700;
            color: var(--primary);
            letter-spacing: -0.5px;
        }

        .logo-accent {
            color: var(--accent);
        }

        .container { 
            max-width: 1600px; 
            margin: 0 auto; 
            padding: 3rem 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .header h1 { 
            font-family: 'Poppins', sans-serif;
            font-size: 2.8em;
            color: var(--primary);
            margin-bottom: 0.5rem;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header p { 
            color: var(--text-gray); 
            font-size: 1.1em;
            margin-bottom: 0.5rem;
        }

        .header .subtitle {
            color: var(--accent);
            font-weight: 500;
            font-size: 0.95em;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 3rem;
        }

        @media (max-width: 1200px) {
            .content {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--bg-white);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 12px rgba(26, 58, 82, 0.08);
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .card:hover {
            box-shadow: 0 4px 20px rgba(26, 58, 82, 0.12);
        }

        .card h2 { 
            color: var(--primary);
            margin-bottom: 1.5rem;
            font-size: 1.5em;
            font-weight: 600;
        }

        .card h3 { 
            color: var(--primary);
            margin-bottom: 1rem;
            margin-top: 1.5rem;
            font-size: 1.1em;
            font-weight: 600;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--accent);
            display: inline-block;
        }

        .form-group { 
            margin-bottom: 1.5rem;
        }

        .form-group label { 
            display: block; 
            margin-bottom: 0.6rem;
            font-weight: 500;
            color: var(--text-dark);
            font-size: 0.95em;
        }

        .form-group select, 
        .form-group input { 
            width: 100%; 
            padding: 0.85rem 1rem; 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            font-size: 1em;
            font-family: 'Inter', sans-serif;
            background: var(--bg-white);
            color: var(--text-dark);
            transition: all 0.2s ease;
        }

        .form-group select:focus, 
        .form-group input:focus { 
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(201, 169, 97, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .checkbox-group {
            background: var(--bg-light);
            padding: 1.2rem;
            border-radius: 8px;
            margin: 1rem 0;
            border-left: 4px solid var(--accent);
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            margin: 0.75rem 0;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 0.75rem;
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--accent);
        }

        .checkbox-item label {
            margin: 0;
            font-weight: 400;
            cursor: pointer;
            flex: 1;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 2rem;
        }

        @media (max-width: 600px) {
            .button-group {
                grid-template-columns: 1fr;
            }
        }

        button {
            padding: 1rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1em;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 58, 82, 0.2);
        }

        .btn-secondary {
            background: var(--bg-light);
            color: var(--text-dark);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #229954;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.2);
        }

        .message {
            padding: 1.2rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            display: none;
            font-weight: 500;
            border-left: 4px solid;
        }

        .message.show {
            display: block;
        }

        .message.error {
            background: #fdeaea;
            color: #c53030;
            border-left-color: #c53030;
        }

        .message.success {
            background: #e6ffed;
            color: #22863a;
            border-left-color: #27ae60;
        }

        .message.warning {
            background: #fff5e1;
            color: #7d4f00;
            border-left-color: #f39c12;
        }

        .results {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .result-row:last-child {
            border-bottom: none;
        }

        .result-label {
            font-weight: 600;
            opacity: 0.9;
        }

        .result-value {
            font-weight: 700;
            font-size: 1.1em;
            color: var(--accent);
        }

        .table-section {
            display: none;
            margin-top: 3rem;
        }

        .table-section.active {
            display: block;
        }

        .table-header {
            background: var(--primary);
            color: white;
            padding: 1.5rem;
            font-weight: 700;
            border-radius: 12px 12px 0 0;
            font-size: 1.1em;
            letter-spacing: 0.5px;
        }

        .table-responsive {
            overflow-x: auto;
            background: var(--bg-white);
            border-radius: 0 0 12px 12px;
            box-shadow: 0 2px 12px rgba(26, 58, 82, 0.08);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95em;
        }

        th {
            background: #f8f9fa;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-dark);
            border-bottom: 2px solid var(--border-color);
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        tbody tr:hover {
            background-color: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .badge-low {
            background: #e6f7e6;
            color: #27ae60;
        }

        .badge-medium {
            background: #fff5e1;
            color: #c9a961;
        }

        .badge-high {
            background: #fdeaea;
            color: #c53030;
        }

        .badge-very-high {
            background: #e1c7d4;
            color: #742a54;
        }

        .recommendation-badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.75em;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .badge-incontournable {
            background: #fff5e1;
            color: #7d4f00;
        }

        .badge-strategique {
            background: #d6f1ff;
            color: #0066cc;
        }

        .badge-portage {
            background: #ffe6e6;
            color: #c53030;
        }

        .badge-coup {
            background: #f3d9e6;
            color: #742a54;
        }

        .badge-immobilier {
            background: #e6f7e6;
            color: #27ae60;
        }

        .badge-pe {
            background: #f0e6ff;
            color: #6c2b8a;
        }

        .esg-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .esg-high {
            background: #e6f7e6;
            color: #27ae60;
        }

        .esg-medium {
            background: #fff5e1;
            color: #c9a961;
        }

        .esg-low {
            background: #fdeaea;
            color: #c53030;
        }

        .geo-badge {
            background: #d6f1ff;
            color: #0066cc;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.8em;
        }

        .constraints-box {
            background: #f0f6ff;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1.5rem 0;
            border-left: 4px solid var(--accent);
        }

        .constraints-box h3 {
            color: var(--primary);
            margin-bottom: 1rem;
            font-size: 1em;
            border: none;
            padding: 0;
        }

        .constraint-item {
            padding: 0.5rem 0;
            color: var(--text-dark);
        }

        .constraint-item strong {
            color: var(--primary);
        }

        .performance-summary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }

        .performance-summary h3 {
            color: white;
            border: none;
            padding: 0;
            margin: 0 0 1.5rem 0;
        }

        .performance-metric {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .performance-metric:last-child {
            border-bottom: none;
        }

        .performance-metric-label {
            font-weight: 600;
        }

        .performance-metric-value {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--accent);
        }

        .yearly-projection {
            background: rgba(255,255,255,0.1);
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1.5rem;
        }

        .yearly-projection h4 {
            color: var(--accent);
            margin-bottom: 1rem;
            font-size: 0.95em;
        }

        .projection-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
        }

        .projection-item {
            background: rgba(255,255,255,0.05);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .projection-item-label {
            font-size: 0.85em;
            opacity: 0.8;
            margin-bottom: 0.5rem;
        }

        .projection-item-value {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--accent);
        }

        .fund-selector {
            max-height: 400px;
            overflow-y: auto;
            background: var(--bg-white);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .fund-selector-item {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
        }

        .fund-selector-item:last-child {
            border-bottom: none;
        }

        .fund-selector-item input[type="checkbox"] {
            margin-right: 0.75rem;
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--accent);
        }

        .fund-selector-item label {
            margin: 0;
            font-weight: 400;
            cursor: pointer;
            flex: 1;
        }

        .eligibility-note {
            background: #fff5e1;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-size: 0.9em;
            color: #7d4f00;
            border-left: 4px solid var(--accent);
        }

        .manual-selection-box {
            background: var(--bg-light);
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1rem 0;
            border: 2px dashed var(--accent);
        }

        .mandatory-fund {
            background: #fff5e1;
        }

        .mandatory-indicator {
            color: #c9a961;
            font-weight: 700;
        }

        .footer {
            text-align: center;
            margin-top: 4rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border-color);
            color: var(--text-gray);
            font-size: 0.9em;
        }

        .footer strong {
            color: var(--text-dark);
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-light);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-light);
        }

        .performance-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .performance-positive {
            background: #e6f7e6;
            color: #27ae60;
        }

        .performance-neutral {
            background: #e8eef5;
            color: #2c3e50;
        }

        .performance-negative {
            background: #fdeaea;
            color: #c53030;
        }
    </style>
</head>
<body>

<nav class="navbar">
    <div class="navbar-content">
        <div class="logo">ODDO BHF<span class="logo-accent"> Fund Allocation</span></div>
        <div style="font-size: 0.9em; color: var(--text-gray);">Professional Edition v3.0</div>
    </div>
</nav>

<div class="container">
    <div class="header">
        <h1>Allocation d'Actifs Optimis√©e</h1>
        <p>Cr√©ez votre portefeuille personnalis√© selon votre profil de risque</p>
        <p class="subtitle">Solution professionnelle ODDO BHF pour le conseil en gestion de patrimoine</p>
    </div>

    <div class="message" id="message"></div>

    <div class="content">
        <div class="card">
            <h2>üìä Configurez Votre Allocation</h2>
            
            <div class="form-group">
                <label>Type de Contrat *</label>
                <select id="contractType" onchange="updateAvailableFunds()">
                    <option value="">-- S√©lectionnez un contrat --</option>
                    <option value="fipavie-ingenierie">Fipavie Ing√©nierie</option>
                    <option value="fipavie-opportunites">Fipavie Opportunit√©s</option>
                    <option value="fipavie-expertises">Fipavie Expertises</option>
                    <option value="fipavie-transmission">Fipavie Transmission</option>
                    <option value="per-opportunites">PER Opportunit√©s</option>
                    <option value="premavenir-per">Premavenir PER</option>
                </select>
            </div>

            <h3>üí∞ Versement Initial (‚Ç¨)</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Montant *</label>
                    <input type="number" id="initialFunding" min="1500" step="100" placeholder="Min: ‚Ç¨1.500" />
                </div>
                <div class="form-group">
                    <label>Profil de Risque *</label>
                    <select id="initialRiskProfile" onchange="updateInitialConstraints()">
                        <option value="">-- S√©lectionnez --</option>
                        <option value="secure">üõ°Ô∏è Prudent</option>
                        <option value="moderate">‚öñÔ∏è √âquilibr√©</option>
                        <option value="dynamic">üìà Dynamique</option>
                    </select>
                </div>
            </div>

            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="manualInitial" onchange="toggleInitialManualSelection()">
                    <label for="manualInitial">S√©lection manuelle des fonds pour versement initial</label>
                </div>
            </div>

            <div id="initialManualSelection" class="manual-selection-box" style="display: none;">
                <h4 style="margin-bottom: 1rem; color: var(--primary);">S√©lectionnez les fonds :</h4>
                <div id="initialFundSelector" class="fund-selector"></div>
                <div id="initialEligibilityNote" class="eligibility-note" style="display: none;"></div>
            </div>

            <div id="initialConstraintsBox" class="constraints-box" style="display: none;">
                <h3>‚úÖ Contraintes Initiales</h3>
                <div id="initialConstraintsList"></div>
            </div>

            <h3>üìä Versement Mensuel (‚Ç¨)</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Montant *</label>
                    <input type="number" id="monthlyFunding" min="150" step="50" placeholder="Min: ‚Ç¨150" />
                </div>
                <div class="form-group">
                    <label>Profil de Risque *</label>
                    <select id="monthlyRiskProfile" onchange="updateMonthlyConstraints()">
                        <option value="">-- S√©lectionnez --</option>
                        <option value="secure">üõ°Ô∏è Prudent</option>
                        <option value="moderate">‚öñÔ∏è √âquilibr√©</option>
                        <option value="dynamic">üìà Dynamique</option>
                    </select>
                </div>
            </div>

            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="manualMonthly" onchange="toggleMonthlyManualSelection()">
                    <label for="manualMonthly">S√©lection manuelle des fonds pour versement mensuel</label>
                </div>
            </div>

            <div id="monthlyManualSelection" class="manual-selection-box" style="display: none;">
                <h4 style="margin-bottom: 1rem; color: var(--primary);">S√©lectionnez les fonds :</h4>
                <div id="monthlyFundSelector" class="fund-selector"></div>
                <div id="monthlyEligibilityNote" class="eligibility-note" style="display: none;"></div>
            </div>

            <div id="monthlyConstraintsBox" class="constraints-box" style="display: none;">
                <h3>‚úÖ Contraintes Mensuelles</h3>
                <div id="monthlyConstraintsList"></div>
            </div>

            <div class="button-group">
                <button class="btn-primary" onclick="calculate()">üìä Calculer l'Allocation</button>
                <button class="btn-secondary" onclick="reset()">üîÑ R√©initialiser</button>
            </div>
        </div>

        <div class="card" id="resultsSection" style="display: none;">
            <h2>‚úÖ R√©sum√© de Votre Allocation</h2>
            <div class="results">
                <div class="result-row">
                    <span class="result-label">Contrat :</span>
                    <span class="result-value" id="summaryContract">-</span>
                </div>
                <div class="result-row">
                    <span class="result-label">Versement Initial :</span>
                    <span class="result-value" id="summaryInitial">-</span>
                </div>
                <div class="result-row">
                    <span class="result-label">Profil :</span>
                    <span class="result-value" id="summaryInitialProfile"></span>
                </div>
                <div class="result-row">
                    <span class="result-label">Versement Mensuel :</span>
                    <span class="result-value" id="summaryMonthly">-</span>
                </div>
                <div class="result-row">
                    <span class="result-label">Profil :</span>
                    <span class="result-value" id="summaryMonthlyProfile"></span>
                </div>
            </div>
            <div class="button-group">
                <button class="btn-success" onclick="savePortfolio()">üíæ Enregistrer</button>
                <button class="btn-success" style="background: var(--info);" onclick="exportCSV()">üì• Exporter CSV</button>
            </div>
        </div>
    </div>

    <div class="table-section" id="initialTableSection">
        <div class="table-header">üí∞ Allocation Initiale</div>
        <div class="performance-summary" id="initialPerformanceSummary"></div>
        <div id="initialWarning" class="message warning" style="display: none; margin-top: -1px;"></div>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Nom du Fonds</th>
                        <th>ISIN</th>
                        <th>Montant (‚Ç¨)</th>
                        <th>% du Portefeuille</th>
                        <th>Risque</th>
                        <th>Zone G√©ographique</th>
                        <th>ESG</th>
                        <th>Performance 1Y</th>
                        <th>Type</th>
                        <th>Strat√©gie</th>
                    </tr>
                </thead>
                <tbody id="initialBody"></tbody>
            </table>
        </div>
    </div>

    <div class="table-section" id="monthlyTableSection">
        <div class="table-header">üìä Allocation Mensuelle</div>
        <div class="performance-summary" id="monthlyPerformanceSummary"></div>
        <div id="monthlyWarning" class="message warning" style="display: none; margin-top: -1px;"></div>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Nom du Fonds</th>
                        <th>ISIN</th>
                        <th>Montant (‚Ç¨)</th>
                        <th>% du Portefeuille</th>
                        <th>Risque</th>
                        <th>Zone G√©ographique</th>
                        <th>ESG</th>
                        <th>Performance 1Y</th>
                        <th>Type</th>
                        <th>Strat√©gie</th>
                    </tr>
                </thead>
                <tbody id="monthlyBody"></tbody>
            </table>
        </div>
    </div>

    <div class="footer">
        <p><strong>¬© 2026 ODDO BHF Asset Management</strong></p>
        <p>Professional Edition v3.0 | Document confidentiel distributeurs</p>
    </div>
</div>

<script>
    // (Tous les scripts restent identiques √† la version pr√©c√©dente)
    // PROFILE-BASED ALLOCATION CONSTRAINTS
    const profileConstraints = {
        secure: {
            name: 'Prudent (Secure)',
            constraints: [
                { type: 'Bonds & Fixed Income', max: 60, min: 50 },
                { type: 'Equities', max: 20, min: 10 },
                { type: 'Mixed Assets', max: 15, min: 5 },
                { type: 'Alternatives', max: 5, min: 0 }
            ],
            mandatory: [
                { fundId: 'fund-securite-infra', minPercent: 10, label: 'S√©curit√© Infra Euro (min 10%)' },
                { fundId: 'fund-securite-euro', minPercent: 10, label: 'S√©curit√© en Euros (min 10%, when eligible)' }
            ]
        },
        moderate: {
            name: '√âquilibr√© (Moderate)',
            constraints: [
                { type: 'Bonds & Fixed Income', max: 40, min: 30 },
                { type: 'Equities', max: 50, min: 40 },
                { type: 'Mixed Assets', max: 10, min: 5 },
                { type: 'Alternatives', max: 5, min: 0 }
            ],
            mandatory: [
                { fundId: 'fund-securite-infra', minPercent: 10, label: 'S√©curit√© Infra Euro (min 10%)' }
            ]
        },
        dynamic: {
            name: 'Dynamique (Dynamic)',
            constraints: [
                { type: 'Equities', max: 100, min: 80 },
                { type: 'Fixed Income', max: 20, min: 0 },
                { type: 'Alternatives', max: 10, min: 0 }
            ],
            mandatory: []
        }
    };

    // CONTRACT ELIGIBILITY RULES
    const contractEligibility = {
        'fipavie-ingenierie': {
            name: 'Fipavie Ing√©nierie',
            immobilier: { 'fund-osmo-valeur': 'max 50% / max 200k‚Ç¨', 'fund-osmo-energie': null, 'fund-allianz-pierre': null },
            pe: { 'fund-pe-debt-equity-ii': 'max 70%', 'fund-pe-global': null, 'fund-slp-opportunites': 'max 50%' }
        },
        'fipavie-opportunites': {
            name: 'Fipavie Opportunit√©s',
            immobilier: { 'fund-osmo-valeur': 'max 50% / max 200k‚Ç¨', 'fund-osmo-energie': 'max 50% / max 200k‚Ç¨', 'fund-allianz-pierre': null },
            pe: { 'fund-pe-debt-equity-ii': 'max 30%', 'fund-pe-global': 'max 30%', 'fund-slp-opportunites': 'max 50%' }
        },
        'fipavie-expertises': {
            name: 'Fipavie Expertises',
            immobilier: { 'fund-osmo-valeur': 'max 50% / max 200k‚Ç¨', 'fund-osmo-energie': null, 'fund-allianz-pierre': null },
            pe: { 'fund-pe-debt-equity-ii': 'max 30%', 'fund-pe-global': null, 'fund-slp-opportunites': 'max 50%' }
        },
        'fipavie-transmission': {
            name: 'Fipavie Transmission',
            immobilier: { 'fund-osmo-valeur': 'max 50%', 'fund-osmo-energie': null, 'fund-allianz-pierre': null },
            pe: { 'fund-pe-debt-equity-ii': 'min 55% / max 70% (Vie G√©n√©ration)', 'fund-pe-global': null, 'fund-slp-opportunites': 'max 50%' }
        },
        'per-opportunites': {
            name: 'PER Opportunit√©s',
            immobilier: { 'fund-osmo-valeur': 'max 50% / max 200k‚Ç¨', 'fund-osmo-energie': null, 'fund-allianz-pierre': null },
            pe: { 'fund-pe-debt-equity-ii': 'max 30%', 'fund-pe-global': 'max 30%', 'fund-slp-opportunites': 'max 50%' }
        },
        'premavenir-per': {
            name: 'Premavenir PER',
            immobilier: { 'fund-osmo-valeur': 'max 60% / max 1M‚Ç¨', 'fund-osmo-energie': null, 'fund-allianz-pierre': null },
            pe: { 'fund-pe-debt-equity-ii': 'max 30%', 'fund-pe-global': 'max 30%', 'fund-slp-opportunites': 'max 50%' }
        }
    };

    // COMPREHENSIVE FUNDS DATABASE
    const funds = [
        // MANDATORY FUNDS FOR CONSERVATIVE & MODERATE
        { fundId: 'fund-securite-infra', name: 'ODDO BHF S√©curit√© Infra Euro', isin: 'LU0876266276', riskLevel: 'Low', assetClass: 'Fixed Income', assetType: 'Bonds & Fixed Income', category: 'MANDATORY', allocation: 0.10, geographicFocus: 'Europe', esgClassification: 'High', performance1Y: 2.85, fundType: 'UCITS', isMandatory: true },
        { fundId: 'fund-securite-euro', name: 'ODDO BHF S√©curit√© en Euros', isin: 'LU0268403865', riskLevel: 'Low', assetClass: 'Fixed Income', assetType: 'Bonds & Fixed Income', category: 'MANDATORY', allocation: 0.10, geographicFocus: 'Europe', esgClassification: 'High', performance1Y: 2.45, fundType: 'UCITS', isMandatory: true },
        
        // INCONTOURNABLE - Essential
        { fundId: 'fund-nav', name: 'ODDO BHF Global Navigator', isin: 'LU0568438842', riskLevel: 'Medium', assetClass: 'Diversified', assetType: 'Mixed Assets', category: 'INCONTOURNABLE', allocation: 0.25, geographicFocus: 'Global', esgClassification: 'High', performance1Y: 5.32, fundType: 'UCITS' },
        { fundId: 'fund-ia', name: 'ODDO BHF Artificial Intelligence', isin: 'LU1803984285', riskLevel: 'High', assetClass: 'Equity', assetType: 'Equities', category: 'INCONTOURNABLE', allocation: 0.20, geographicFocus: 'Global', esgClassification: 'High', performance1Y: 8.75, fundType: 'UCITS' },
        { fundId: 'fund-ger', name: 'ODDO BHF German Equities', isin: 'LU0502241003', riskLevel: 'High', assetClass: 'Equity', assetType: 'Equities', category: 'INCONTOURNABLE', allocation: 0.18, geographicFocus: 'Europe', esgClassification: 'Medium', performance1Y: 6.42, fundType: 'UCITS' },
        
        // STRAT√âGIQUE - Strategic
        { fundId: 'fund-metro', name: 'ODDO BHF M√©tropole Euro', isin: 'LU0211427521', riskLevel: 'Medium', assetClass: 'Equity', assetType: 'Equities', category: 'STRATEGIQUE', allocation: 0.20, geographicFocus: 'Europe', esgClassification: 'High', performance1Y: 4.18, fundType: 'UCITS' },
        { fundId: 'fund-china', name: 'ODDO BHF China Equity Stars', isin: 'LU0697003994', riskLevel: 'High', assetClass: 'Equity', assetType: 'Equities', category: 'STRATEGIQUE', allocation: 0.18, geographicFocus: 'Asia', esgClassification: 'Medium', performance1Y: 7.56, fundType: 'UCITS' },
        
        // PORTAGE - Carry Trade / Fixed Income
        { fundId: 'fund-target', name: 'ODDO BHF Global Target 2031', isin: 'LU1598873842', riskLevel: 'Medium', assetClass: 'Fixed Income', assetType: 'Mixed Assets', category: 'PORTAGE', allocation: 0.20, geographicFocus: 'Global', esgClassification: 'Medium', performance1Y: 3.64, fundType: 'UCITS' },
        
        // COUP DE C≈íUR - Favorites
        { fundId: 'fund-credit', name: 'ODDO BHF Euro Credit Short Duration', isin: 'LU0410170084', riskLevel: 'Low', assetClass: 'Fixed Income', assetType: 'Bonds & Fixed Income', category: 'COUP', allocation: 0.15, geographicFocus: 'Europe', esgClassification: 'High', performance1Y: 2.75, fundType: 'UCITS' },
        { fundId: 'fund-algo', name: 'ODDO BHF Algo Trend US', isin: 'LU0913291672', riskLevel: 'High', assetClass: 'Equity', assetType: 'Equities', category: 'COUP', allocation: 0.18, geographicFocus: 'North America', esgClassification: 'Medium', performance1Y: 9.12, fundType: 'UCITS' },
        { fundId: 'fund-small', name: 'ODDO BHF Active Small Cap', isin: 'LU0501210403', riskLevel: 'High', assetClass: 'Equity', assetType: 'Equities', category: 'COUP', allocation: 0.16, geographicFocus: 'Europe', esgClassification: 'Medium', performance1Y: 5.89, fundType: 'UCITS' },
        
        // Additional supporting funds
        { fundId: 'fund-avenir', name: 'ODDO BHF Avenir Europe', isin: 'LU0212090670', riskLevel: 'Medium', assetClass: 'Equity', assetType: 'Equities', category: 'SUPPORT', allocation: 0.17, geographicFocus: 'Europe', esgClassification: 'High', performance1Y: 6.34, fundType: 'UCITS' },
        { fundId: 'fund-polaris', name: 'ODDO BHF Polaris Balanced', isin: 'LU0789568872', riskLevel: 'Medium', assetClass: 'Diversified', assetType: 'Mixed Assets', category: 'SUPPORT', allocation: 0.18, geographicFocus: 'Global', esgClassification: 'High', performance1Y: 4.76, fundType: 'UCITS' },
        { fundId: 'fund-moderate', name: 'ODDO BHF Polaris Moderate', isin: 'LU0789568780', riskLevel: 'Low', assetClass: 'Diversified', assetType: 'Mixed Assets', category: 'SUPPORT', allocation: 0.15, geographicFocus: 'Global', esgClassification: 'High', performance1Y: 3.21, fundType: 'UCITS' },
        
        // IMMOBILIER - Real Estate
        { fundId: 'fund-osmo-valeur', name: 'SCI Osmo Valeur (Mata Capital)', isin: 'FR0014007LB4', riskLevel: 'Medium', assetClass: 'Real Estate', assetType: 'Immobilier', category: 'IMMOBILIER', allocation: 0.15, geographicFocus: 'France', esgClassification: 'Medium', performance1Y: 3.50, fundType: 'SCI', contractEligible: ['fipavie-ingenierie', 'fipavie-opportunites', 'fipavie-expertises', 'per-opportunites', 'premavenir-per'] },
        { fundId: 'fund-osmo-energie', name: 'SCPI Osmo Energie', isin: 'FR001400KK24', riskLevel: 'Medium', assetClass: 'Real Estate', assetType: 'Immobilier', category: 'IMMOBILIER', allocation: 0.12, geographicFocus: 'France', esgClassification: 'High', performance1Y: 3.75, fundType: 'SCPI', contractEligible: ['fipavie-opportunites', 'fipavie-opportunites-capitalisation'] },
        { fundId: 'fund-allianz-pierre', name: 'Allianz Invest Pierre', isin: 'FR00140118H6', riskLevel: 'Low', assetClass: 'Real Estate', assetType: 'Immobilier', category: 'IMMOBILIER', allocation: 0.10, geographicFocus: 'France', esgClassification: 'Medium', performance1Y: 2.90, fundType: 'SCPI' },
        
        // PRIVATE EQUITY
        { fundId: 'fund-pe-global', name: 'FCPR ODDO BHF Global Private Equity', isin: 'FR00140118F0', riskLevel: 'Very High', assetClass: 'Private Equity', assetType: 'Private Equity', category: 'PE', allocation: 0.12, geographicFocus: 'Global', esgClassification: 'Medium', performance1Y: 6.50, fundType: 'FCPR', contractEligible: ['fipavie-opportunites', 'per-opportunites', 'premavenir-per'] },
        { fundId: 'fund-pe-debt-equity', name: 'FCPR ODDO BHF Debt & Equity Opportunities', isin: 'FR001400KK24', riskLevel: 'High', assetClass: 'Private Equity', assetType: 'Private Equity', category: 'PE', allocation: 0.10, geographicFocus: 'Global', esgClassification: 'Low', performance1Y: 5.80, fundType: 'FCPR' },
        { fundId: 'fund-pe-debt-equity-ii', name: 'FCPR ODDO BHF Debt & Equity Opportunities II', isin: 'FR001400LRK9', riskLevel: 'High', assetClass: 'Private Equity', assetType: 'Private Equity', category: 'PE', allocation: 0.15, geographicFocus: 'Global', esgClassification: 'Low', performance1Y: 5.95, fundType: 'FCPR', contractEligible: ['fipavie-ingenierie', 'fipavie-opportunites', 'fipavie-expertises', 'fipavie-transmission', 'per-opportunites', 'premavenir-per'] },
        { fundId: 'fund-slp-opportunites', name: 'SLP ODDO BHF Opportunit√©s Strat√©giques', isin: 'FR001400KK24', riskLevel: 'Very High', assetClass: 'Private Equity', assetType: 'Private Equity', category: 'PE', allocation: 0.12, geographicFocus: 'Global', esgClassification: 'Medium', performance1Y: 7.20, fundType: 'SLP', contractEligible: ['fipavie-ingenierie', 'fipavie-opportunites', 'fipavie-expertises', 'fipavie-transmission', 'per-opportunites', 'premavenir-per'] }
    ];

    const contracts = {
        'fipavie-ingenierie': { name: 'Fipavie Ing√©nierie', funds: { secure: ['fund-securite-infra', 'fund-securite-euro', 'fund-nav', 'fund-target', 'fund-credit', 'fund-moderate', 'fund-polaris'], moderate: ['fund-securite-infra', 'fund-nav', 'fund-metro', 'fund-avenir', 'fund-polaris', 'fund-target'], dynamic: ['fund-ia', 'fund-ger', 'fund-algo', 'fund-small', 'fund-metro', 'fund-china'] } },
        'fipavie-opportunites': { name: 'Fipavie Opportunit√©s', funds: { secure: ['fund-securite-infra', 'fund-securite-euro', 'fund-credit', 'fund-target', 'fund-moderate', 'fund-nav'], moderate: ['fund-securite-infra', 'fund-metro', 'fund-avenir', 'fund-polaris', 'fund-nav', 'fund-credit'], dynamic: ['fund-ia', 'fund-ger', 'fund-algo', 'fund-china', 'fund-small'] } },
        'fipavie-expertises': { name: 'Fipavie Expertises', funds: { secure: ['fund-securite-infra', 'fund-securite-euro', 'fund-credit', 'fund-target', 'fund-moderate'], moderate: ['fund-securite-infra', 'fund-metro', 'fund-polaris', 'fund-nav', 'fund-avenir'], dynamic: ['fund-ia', 'fund-ger', 'fund-algo', 'fund-china'] } },
        'fipavie-transmission': { name: 'Fipavie Transmission', funds: { secure: ['fund-securite-infra', 'fund-credit', 'fund-moderate'], moderate: ['fund-securite-infra', 'fund-metro', 'fund-polaris'], dynamic: ['fund-ia', 'fund-ger', 'fund-algo'] } },
        'per-opportunites': { name: 'PER Opportunit√©s', funds: { secure: ['fund-securite-infra', 'fund-securite-euro', 'fund-credit', 'fund-target', 'fund-moderate'], moderate: ['fund-securite-infra', 'fund-metro', 'fund-polaris', 'fund-nav'], dynamic: ['fund-ia', 'fund-ger', 'fund-algo', 'fund-small'] } },
        'premavenir-per': { name: 'Premavenir PER', funds: { secure: ['fund-securite-infra', 'fund-credit', 'fund-moderate'], moderate: ['fund-securite-infra', 'fund-metro', 'fund-polaris'], dynamic: ['fund-ia', 'fund-ger', 'fund-algo'] } }
    };

    let currentAllocation = null;
    let selectedInitialFunds = [];
    let selectedMonthlyFunds = [];

    function updateAvailableFunds() {
        const contractType = document.getElementById('contractType').value;
        if (contractType) {
            updateInitialConstraints();
            updateMonthlyConstraints();
            populateFundSelectors();
        }
    }

    function populateFundSelectors() {
        const contractType = document.getElementById('contractType').value;
        const initialProfile = document.getElementById('initialRiskProfile').value;
        const monthlyProfile = document.getElementById('monthlyRiskProfile').value;

        if (initialProfile && contractType) {
            const initialContainer = document.getElementById('initialFundSelector');
            const initialFundIds = contracts[contractType].funds[initialProfile] || [];
            const eligibleFunds = funds.filter(f => initialFundIds.includes(f.fundId));
            initialContainer.innerHTML = eligibleFunds.map(fund => `
                <div class="fund-selector-item">
                    <input type="checkbox" id="initial_${fund.fundId}" onchange="updateSelectedInitialFunds()">
                    <label for="initial_${fund.fundId}"><strong>${fund.name}</strong> (${fund.performance1Y}%)</label>
                </div>
            `).join('');
        }

        if (monthlyProfile && contractType) {
            const monthlyContainer = document.getElementById('monthlyFundSelector');
            const monthlyFundIds = contracts[contractType].funds[monthlyProfile] || [];
            const eligibleFunds = funds.filter(f => monthlyFundIds.includes(f.fundId));
            monthlyContainer.innerHTML = eligibleFunds.map(fund => `
                <div class="fund-selector-item">
                    <input type="checkbox" id="monthly_${fund.fundId}" onchange="updateSelectedMonthlyFunds()">
                    <label for="monthly_${fund.fundId}"><strong>${fund.name}</strong> (${fund.performance1Y}%)</label>
                </div>
            `).join('');
        }

        displayEligibilityNotes(contractType);
    }

    function displayEligibilityNotes(contractType) {
        const eligibility = contractEligibility[contractType];
        if (!eligibility) return;

        let immobilierNote = '<strong>Immobilier:</strong> ';
        let peNote = '<strong>Private Equity:</strong> ';

        Object.entries(eligibility.immobilier).forEach(([fundId, rules]) => {
            if (rules) {
                const fund = funds.find(f => f.fundId === fundId);
                immobilierNote += `${fund.name} ${rules} | `;
            }
        });

        Object.entries(eligibility.pe).forEach(([fundId, rules]) => {
            if (rules) {
                const fund = funds.find(f => f.fundId === fundId);
                peNote += `${fund.name} ${rules} | `;
            }
        });

        const initialNote = document.getElementById('initialEligibilityNote');
        const monthlyNote = document.getElementById('monthlyEligibilityNote');

        if (document.getElementById('manualInitial').checked) {
            initialNote.innerHTML = immobilierNote + '<br>' + peNote;
            initialNote.style.display = 'block';
        }
        if (document.getElementById('manualMonthly').checked) {
            monthlyNote.innerHTML = immobilierNote + '<br>' + peNote;
            monthlyNote.style.display = 'block';
        }
    }

    function updateSelectedInitialFunds() {
        selectedInitialFunds = Array.from(document.querySelectorAll('#initialFundSelector input[type="checkbox"]:checked')).map(cb => cb.id.replace('initial_', ''));
    }

    function updateSelectedMonthlyFunds() {
        selectedMonthlyFunds = Array.from(document.querySelectorAll('#monthlyFundSelector input[type="checkbox"]:checked')).map(cb => cb.id.replace('monthly_', ''));
    }

    function toggleInitialManualSelection() {
        const checkbox = document.getElementById('manualInitial');
        document.getElementById('initialManualSelection').style.display = checkbox.checked ? 'block' : 'none';
        if (checkbox.checked && selectedInitialFunds.length === 0) {
            populateFundSelectors();
        }
    }

    function toggleMonthlyManualSelection() {
        const checkbox = document.getElementById('manualMonthly');
        document.getElementById('monthlyManualSelection').style.display = checkbox.checked ? 'block' : 'none';
        if (checkbox.checked && selectedMonthlyFunds.length === 0) {
            populateFundSelectors();
        }
    }

    function displayConstraints(profileType, constraintListId) {
        const profile = profileType === 'initial' ? document.getElementById('initialRiskProfile').value : document.getElementById('monthlyRiskProfile').value;
        const constraintsBox = document.getElementById(profileType === 'initial' ? 'initialConstraintsBox' : 'monthlyConstraintsBox');
        const constraintsList = document.getElementById(constraintListId);

        if (!profile) {
            constraintsBox.style.display = 'none';
            return;
        }

        const constraints = profileConstraints[profile];
        constraintsList.innerHTML = '';

        constraints.constraints.forEach(constraint => {
            const item = document.createElement('div');
            item.className = 'constraint-item';
            item.innerHTML = `<strong>${constraint.type}:</strong> Min ${constraint.min}% - Max ${constraint.max}%`;
            constraintsList.appendChild(item);
        });

        if (constraints.mandatory.length > 0) {
            const mandatoryTitle = document.createElement('div');
            mandatoryTitle.className = 'constraint-item';
            mandatoryTitle.style.marginTop = '1rem';
            mandatoryTitle.style.fontWeight = '700';
            mandatoryTitle.style.color = '#c9a961';
            mandatoryTitle.innerHTML = 'üîí Allocations Obligatoires:';
            constraintsList.appendChild(mandatoryTitle);

            constraints.mandatory.forEach(mandatory => {
                const item = document.createElement('div');
                item.className = 'constraint-item';
                item.style.marginLeft = '1rem';
                item.innerHTML = `<strong style="color: #c9a961;">‚Üí ${mandatory.label}</strong>`;
                constraintsList.appendChild(item);
            });
        }

        constraintsBox.style.display = 'block';
    }

    function updateInitialConstraints() {
        displayConstraints('initial', 'initialConstraintsList');
    }

    function updateMonthlyConstraints() {
        displayConstraints('monthly', 'monthlyConstraintsList');
    }

    function getCategoryBadge(category) {
        switch(category) {
            case 'INCONTOURNABLE': return '<span class="recommendation-badge badge-incontournable">‚≠ê Incontournable</span>';
            case 'STRATEGIQUE': return '<span class="recommendation-badge badge-strategique">üìä Strat√©gique</span>';
            case 'PORTAGE': return '<span class="recommendation-badge badge-portage">üí∞ Portage</span>';
            case 'COUP': return '<span class="recommendation-badge badge-coup">‚ù§Ô∏è Coup</span>';
            case 'IMMOBILIER': return '<span class="recommendation-badge badge-immobilier">üè† Immobilier</span>';
            case 'PE': return '<span class="recommendation-badge badge-pe">üíé PE</span>';
            case 'MANDATORY': return '<span class="recommendation-badge" style="background: #fff5e1; color: #c9a961;">üîí Obligatoire</span>';
            default: return '<span class="recommendation-badge" style="background: #f0f6ff; color: #0066cc;">üìå Support</span>';
        }
    }

    function getRiskBadgeClass(riskLevel) {
        switch(riskLevel.toLowerCase()) {
            case 'low': return 'badge-low';
            case 'medium': return 'badge-medium';
            case 'high': return 'badge-high';
            case 'very high': return 'badge-very-high';
            default: return 'badge-medium';
        }
    }

    function getESGBadgeClass(esg) {
        switch(esg.toLowerCase()) {
            case 'high': return 'esg-high';
            case 'medium': return 'esg-medium';
            case 'low': return 'esg-low';
            default: return 'esg-medium';
        }
    }

    function getPerformanceBadgeClass(performance) {
        if (performance >= 7) return 'performance-positive';
        if (performance >= 4) return 'performance-neutral';
        return 'performance-negative';
    }

    function formatPerformance(performance) {
        return performance.toFixed(2) + '%';
    }

    function calculate() {
        const contractId = document.getElementById('contractType').value;
        const initialProfile = document.getElementById('initialRiskProfile').value;
        const monthlyProfile = document.getElementById('monthlyRiskProfile').value;
        const initialFunding = parseFloat(document.getElementById('initialFunding').value);
        const monthlyFunding = parseFloat(document.getElementById('monthlyFunding').value);

        if (!contractId || !initialProfile || !monthlyProfile || isNaN(initialFunding) || initialFunding < 1500 || isNaN(monthlyFunding) || monthlyFunding < 150) {
            showMsg('‚ùå Veuillez remplir tous les champs avec des valeurs valides', 'error');
            return;
        }

        const contract = contracts[contractId];
        
        let initialFundIds, monthlyFundIds;

        if (document.getElementById('manualInitial').checked) {
            initialFundIds = selectedInitialFunds;
        } else {
            initialFundIds = contract.funds[initialProfile];
        }

        if (document.getElementById('manualMonthly').checked) {
            monthlyFundIds = selectedMonthlyFunds;
        } else {
            monthlyFundIds = contract.funds[monthlyProfile];
        }
        
        const initialSelectedFunds = funds.filter(f => initialFundIds.includes(f.fundId));
        const monthlySelectedFunds = funds.filter(f => monthlyFundIds.includes(f.fundId));

        const initialAllocation = allocateFundsWithConstraints(initialSelectedFunds, initialFunding, initialProfile, 5, 10);
        const monthlyAllocation = allocateFundsWithConstraints(monthlySelectedFunds, monthlyFunding, monthlyProfile, 3, monthlySelectedFunds.length, 50);

        if (!initialAllocation || !monthlyAllocation) {
            showMsg('‚ùå Impossible d\'allouer les fonds tout en respectant les contraintes du profil', 'error');
            return;
        }

        currentAllocation = {
            contractId,
            initialProfile,
            monthlyProfile,
            initialFunding,
            monthlyFunding,
            initialAllocation,
            monthlyAllocation
        };

        displayResults(contract, initialProfile, monthlyProfile, initialFunding, monthlyFunding, initialAllocation, monthlyAllocation);
        showMsg('‚úÖ Allocation calcul√©e avec succ√®s!', 'success');
    }

    function allocateFundsWithConstraints(fundsList, totalAmount, profile, minFunds, maxFunds, minPerFund = 50) {
        let allocations = [];
        const constraints = profileConstraints[profile];
        const mandatoryFunds = constraints.mandatory;
        
        const mandatoryAllocations = [];
        let remainingAmount = totalAmount;
        
        mandatoryFunds.forEach(mandatory => {
            const fundData = fundsList.find(f => f.fundId === mandatory.fundId);
            if (fundData) {
                const mandatoryAmount = Math.floor((mandatory.minPercent / 100) * totalAmount);
                mandatoryAllocations.push({
                    ...fundData,
                    calculatedAmount: mandatoryAmount,
                    percentage: mandatory.minPercent,
                    isMandatory: true
                });
                remainingAmount -= mandatoryAmount;
            }
        });

        const nonMandatoryFunds = fundsList.filter(f => !mandatoryFunds.some(m => m.fundId === f.fundId));
        const numFunds = Math.min(maxFunds, Math.max(minFunds, Math.ceil(nonMandatoryFunds.length / 2)));
        const selectedFundsList = nonMandatoryFunds.slice(0, numFunds - mandatoryAllocations.length);
        
        const amountPerFund = Math.floor(remainingAmount / selectedFundsList.length / 50) * 50;
        
        selectedFundsList.forEach(fund => {
            if (amountPerFund >= minPerFund) {
                allocations.push({
                    ...fund,
                    calculatedAmount: amountPerFund
                });
            }
        });

        const totalAllocated = allocations.reduce((a, b) => a + b.calculatedAmount, 0) + mandatoryAllocations.reduce((a, b) => a + b.calculatedAmount, 0);
        const remainder = totalAmount - totalAllocated;
        
        if (remainder >= minPerFund && allocations.length > 0) {
            allocations[0].calculatedAmount += remainder;
        } else if (remainder >= minPerFund && mandatoryAllocations.length > 0) {
            mandatoryAllocations[0].calculatedAmount += remainder;
        }

        const allAllocations = [...mandatoryAllocations, ...allocations];
        
        const allAllocationsWithPercentages = allAllocations.map(alloc => ({
            ...alloc,
            percentage: (alloc.calculatedAmount / totalAmount) * 100
        }));

        return allAllocationsWithPercentages;
    }

    function calculateWeightedPerformance(allocation) {
        return allocation.reduce((sum, fund) => {
            return sum + (fund.performance1Y * (fund.percentage / 100));
        }, 0);
    }

    function calculateProjectedValue(initialAmount, performance, years = 1) {
        return initialAmount * Math.pow((1 + performance / 100), years);
    }

    function createPerformanceSummary(allocation, totalAmount) {
        const avgPerformance = calculateWeightedPerformance(allocation);
        const projectedValue1Y = calculateProjectedValue(totalAmount, avgPerformance, 1);
        const projectedGain1Y = projectedValue1Y - totalAmount;
        const projectedValue5Y = calculateProjectedValue(totalAmount, avgPerformance, 5);

        let html = `
            <div class="performance-metric">
                <span class="performance-metric-label">üìä Performance Moyenne Pond√©r√©e (1Y) :</span>
                <span class="performance-metric-value">${avgPerformance.toFixed(2)}%</span>
            </div>
            <div class="performance-metric">
                <span class="performance-metric-label">üí∞ Valeur Projet√©e (1 An) :</span>
                <span class="performance-metric-value">‚Ç¨${projectedValue1Y.toLocaleString('fr-FR', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
            </div>
            <div class="performance-metric">
                <span class="performance-metric-label">üìà Gain Projet√© (1 An) :</span>
                <span class="performance-metric-value">‚Ç¨${projectedGain1Y.toLocaleString('fr-FR', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
            </div>
            <div class="yearly-projection">
                <h4>üìÖ Projections Multi-Ann√©es</h4>
                <div class="projection-row">
                    <div class="projection-item">
                        <div class="projection-item-label">1 An</div>
                        <div class="projection-item-value">‚Ç¨${projectedValue1Y.toLocaleString('fr-FR', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                    </div>
                    <div class="projection-item">
                        <div class="projection-item-label">3 Ans</div>
                        <div class="projection-item-value">‚Ç¨${calculateProjectedValue(totalAmount, avgPerformance, 3).toLocaleString('fr-FR', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                    </div>
                    <div class="projection-item">
                        <div class="projection-item-label">5 Ans</div>
                        <div class="projection-item-value">‚Ç¨${projectedValue5Y.toLocaleString('fr-FR', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                    </div>
                    <div class="projection-item">
                        <div class="projection-item-label">10 Ans</div>
                        <div class="projection-item-value">‚Ç¨${calculateProjectedValue(totalAmount, avgPerformance, 10).toLocaleString('fr-FR', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                    </div>
                </div>
            </div>
        `;
        return html;
    }

    function displayResults(contract, initialProfile, monthlyProfile, initialFunding, monthlyFunding, initialAllocation, monthlyAllocation) {
        document.getElementById('resultsSection').style.display = 'block';
        document.getElementById('summaryContract').textContent = contract.name;
        document.getElementById('summaryInitial').textContent = `‚Ç¨${initialFunding.toLocaleString('fr-FR')}`;
        document.getElementById('summaryInitialProfile').textContent = profileConstraints[initialProfile].name;
        document.getElementById('summaryMonthly').textContent = `‚Ç¨${monthlyFunding.toLocaleString('fr-FR')}`;
        document.getElementById('summaryMonthlyProfile').textContent = profileConstraints[monthlyProfile].name;

        document.getElementById('initialPerformanceSummary').innerHTML = createPerformanceSummary(initialAllocation, initialFunding);
        document.getElementById('monthlyPerformanceSummary').innerHTML = createPerformanceSummary(monthlyAllocation, monthlyFunding);

        displayTable('initialBody', initialAllocation, initialFunding);
        displayTable('monthlyBody', monthlyAllocation, monthlyFunding);

        document.getElementById('initialTableSection').classList.add('active');
        document.getElementById('monthlyTableSection').classList.add('active');
    }

    function displayTable(tableBodyId, allocations, totalAmount) {
        const tbody = document.getElementById(tableBodyId);
        tbody.innerHTML = '';

        allocations.forEach(fund => {
            const row = document.createElement('tr');
            if (fund.isMandatory) {
                row.className = 'mandatory-fund';
            }
            const riskClass = getRiskBadgeClass(fund.riskLevel);
            const esgClass = getESGBadgeClass(fund.esgClassification);
            const performanceClass = getPerformanceBadgeClass(fund.performance1Y);

            const mandatoryIndicator = fund.isMandatory ? '<span class="mandatory-indicator">üîí</span> ' : '';

            row.innerHTML = `
                <td>${mandatoryIndicator}${fund.name}</td>
                <td><code style="background: #f0f6ff; padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.85em; color: #0066cc;">${fund.isin}</code></td>
                <td>‚Ç¨${fund.calculatedAmount.toLocaleString('fr-FR')}</td>
                <td><strong>${fund.percentage.toFixed(1)}%</strong></td>
                <td><span class="badge ${riskClass}">${fund.riskLevel}</span></td>
                <td><span class="geo-badge">${fund.geographicFocus}</span></td>
                <td><span class="esg-badge ${esgClass}">${fund.esgClassification}</span></td>
                <td><span class="performance-badge ${performanceClass}"><strong>${formatPerformance(fund.performance1Y)}</strong></span></td>
                <td><span class="badge" style="background: #f0f6ff; color: #0066cc;">${fund.fundType}</span></td>
                <td>${getCategoryBadge(fund.category)}</td>
            `;
            tbody.appendChild(row);
        });

        const totalRow = document.createElement('tr');
        totalRow.style.background = '#f0f6ff';
        totalRow.style.fontWeight = '600';
        totalRow.style.borderTop = '2px solid var(--primary)';
        const totalPercent = allocations.reduce((sum, f) => sum + f.percentage, 0);
        const avgPerformance = calculateWeightedPerformance(allocations);
        totalRow.innerHTML = `
            <td colspan="2"><strong>TOTAL</strong></td>
            <td>‚Ç¨${totalAmount.toLocaleString('fr-FR')}</td>
            <td><strong>${totalPercent.toFixed(1)}%</strong></td>
            <td colspan="3"></td>
            <td><span class="performance-badge" style="background: var(--primary); color: white;"><strong>${formatPerformance(avgPerformance)}</strong></span></td>
            <td colspan="2"></td>
        `;
        tbody.appendChild(totalRow);
    }

    function savePortfolio() {
        if (!currentAllocation) {
            showMsg('‚ùå Aucune allocation √† enregistrer', 'error');
            return;
        }
        showMsg('‚úÖ Portefeuille enregistr√© avec succ√®s!', 'success');
        setTimeout(() => reset(), 1500);
    }

    function exportCSV() {
        if (!currentAllocation) {
            showMsg('‚ùå Aucune allocation √† exporter', 'error');
            return;
        }

        const initialAvgPerf = calculateWeightedPerformance(currentAllocation.initialAllocation);
        const monthlyAvgPerf = calculateWeightedPerformance(currentAllocation.monthlyAllocation);

        let csv = 'ODDO BHF - Rapport d\'Allocation de Fonds\n';
        csv += `G√©n√©r√©: ${new Date().toLocaleDateString('fr-FR')}\n`;
        csv += `Contrat: ${contracts[currentAllocation.contractId].name}\n\n`;

        csv += 'ALLOCATION INITIALE\n';
        csv += `Profil: ${profileConstraints[currentAllocation.initialProfile].name}\n`;
        csv += `Montant Total: ‚Ç¨${currentAllocation.initialFunding.toLocaleString('fr-FR')}\n`;
        csv += `Performance Moyenne Pond√©r√©e (1Y): ${initialAvgPerf.toFixed(2)}%\n\n`;
        csv += 'Nom du Fonds,ISIN,Montant (‚Ç¨),Pourcentage (%),Risque,Zone G√©ographique,ESG,Performance 1Y (%),Type de Fonds,Cat√©gorie,Obligatoire\n';
        currentAllocation.initialAllocation.forEach(fund => {
            csv += `"${fund.name}","${fund.isin}",${fund.calculatedAmount},${fund.percentage.toFixed(1)},${fund.riskLevel},"${fund.geographicFocus}","${fund.esgClassification}",${fund.performance1Y.toFixed(2)},"${fund.fundType}","${fund.category}","${fund.isMandatory ? 'OUI' : 'NON'}"\n`;
        });

        csv += '\nALLOCATION MENSUELLE\n';
        csv += `Profil: ${profileConstraints[currentAllocation.monthlyProfile].name}\n`;
        csv += `Montant Total: ‚Ç¨${currentAllocation.monthlyFunding.toLocaleString('fr-FR')}\n`;
        csv += `Performance Moyenne Pond√©r√©e (1Y): ${monthlyAvgPerf.toFixed(2)}%\n\n`;
        csv += 'Nom du Fonds,ISIN,Montant (‚Ç¨),Pourcentage (%),Risque,Zone G√©ographique,ESG,Performance 1Y (%),Type de Fonds,Cat√©gorie,Obligatoire\n';
        currentAllocation.monthlyAllocation.forEach(fund => {
            csv += `"${fund.name}","${fund.isin}",${fund.calculatedAmount},${fund.percentage.toFixed(1)},${fund.riskLevel},"${fund.geographicFocus}","${fund.esgClassification}",${fund.performance1Y.toFixed(2)},"${fund.fundType}","${fund.category}","${fund.isMandatory ? 'OUI' : 'NON'}"\n`;
        });

        const element = document.createElement('a');
        element.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv));
        element.setAttribute('download', `ODDO_BHF_Allocation_${Date.now()}.csv`);
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);

        showMsg('‚úÖ Rapport export√© en CSV!', 'success');
    }

    function reset() {
        document.getElementById('contractType').value = '';
        document.getElementById('initialRiskProfile').value = '';
        document.getElementById('monthlyRiskProfile').value = '';
        document.getElementById('initialFunding').value = '';
        document.getElementById('monthlyFunding').value = '';
        document.getElementById('manualInitial').checked = false;
        document.getElementById('manualMonthly').checked = false;
        document.getElementById('initialManualSelection').style.display = 'none';
        document.getElementById('monthlyManualSelection').style.display = 'none';
        document.getElementById('resultsSection').style.display = 'none';
        document.getElementById('initialConstraintsBox').style.display = 'none';
        document.getElementById('monthlyConstraintsBox').style.display = 'none';
        document.getElementById('initialTableSection').classList.remove('active');
        document.getElementById('monthlyTableSection').classList.remove('active');
        selectedInitialFunds = [];
        selectedMonthlyFunds = [];
        currentAllocation = null;
    }

    function showMsg(message, type) {
        const msgElement = document.getElementById('message');
        msgElement.textContent = message;
        msgElement.className = `message show ${type}`;
        setTimeout(() => msgElement.classList.remove('show'), 4000);
    }
</script>

</body>
</html>
