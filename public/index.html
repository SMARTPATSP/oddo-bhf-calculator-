<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ODDO BHF Fund Allocation Tool</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 12px; padding: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .header { text-align: center; margin-bottom: 40px; border-bottom: 3px solid #667eea; padding-bottom: 20px; }
        .header h1 { font-size: 2.5em; color: #333; }
        .header p { color: #666; margin-top: 10px; }
        .content { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        @media (max-width: 1200px) { .content { grid-template-columns: 1fr; } }
        .section { background: #f8f9fa; padding: 30px; border-radius: 8px; border-left: 4px solid #667eea; }
        .section h2 { color: #333; margin-bottom: 20px; font-size: 1.3em; }
        .section h3 { color: #555; margin-bottom: 15px; margin-top: 20px; font-size: 1.1em; border-bottom: 2px solid #ddd; padding-bottom: 8px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
        .form-group select, .form-group input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 1em; }
        .form-group select:focus, .form-group input:focus { border-color: #667eea; outline: none; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @media (max-width: 600px) { .form-row { grid-template-columns: 1fr; } }
        button { padding: 12px 24px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; font-size: 1em; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 15px rgba(102, 126, 234, 0.3); }
        .btn-secondary { background: #e9ecef; color: #333; }
        .btn-success { background: #28a745; color: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.95em; }
        th { background: #667eea; color: white; padding: 12px; text-align: left; font-weight: bold; }
        td { padding: 10px; border-bottom: 1px solid #ddd; }
        tr:hover { background: #f9f9f9; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; margin-right: 4px; }
        .badge-low { background: #d4edda; color: #155724; }
        .badge-medium { background: #fff3cd; color: #856404; }
        .badge-high { background: #f8d7da; color: #721c24; }
        .badge-very-high { background: #e2616c; color: white; }
        .message { padding: 15px; border-radius: 6px; margin-bottom: 20px; display: none; font-weight: bold; }
        .message.show { display: block; }
        .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message.warning { background: #fff3cd; color: #856404; border: 1px solid #ffc107; }
        .table-section { display: none; margin-top: 30px; }
        .table-section.active { display: block; }
        .table-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; font-weight: bold; margin-bottom: 0; border-radius: 6px 6px 0 0; }
        .results { background: white; padding: 20px; border-left: 4px solid #667eea; margin-bottom: 20px; border-radius: 6px; }
        .result-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; }
        .result-label { font-weight: bold; color: #333; }
        .result-value { color: #667eea; font-weight: bold; font-size: 1.1em; }
        .footer { text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 0.9em; }
        .recommendation-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.75em; font-weight: bold; margin-left: 5px; }
        .badge-incontournable { background: #FFD700; color: #333; }
        .badge-strategique { background: #87CEEB; color: #333; }
        .badge-portage { background: #FFA500; color: white; }
        .badge-coup { background: #FF69B4; color: white; }
        .constraints-box { background: #e8f4f8; padding: 15px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #0066cc; }
        .constraints-box h3 { color: #0066cc; margin-bottom: 10px; font-size: 1em; }
        .constraint-item { padding: 5px 0; color: #333; }
        .constraint-item strong { color: #0066cc; }
        .small-text { font-size: 0.85em; color: #666; }
        .allocation-warning { background: #fff3cd; border: 1px solid #ffc107; padding: 10px; border-radius: 4px; margin-bottom: 15px; color: #856404; }
        .table-responsive { overflow-x: auto; }
        .esg-badge { padding: 3px 6px; border-radius: 3px; font-size: 0.75em; font-weight: bold; }
        .esg-high { background: #d4edda; color: #155724; }
        .esg-medium { background: #fff3cd; color: #856404; }
        .esg-low { background: #f8d7da; color: #721c24; }
        .geo-badge { background: #e7f3ff; color: #0066cc; padding: 3px 6px; border-radius: 3px; font-size: 0.75em; }
        .mandatory-fund { background: #fff8dc; border-left: 3px solid #ff6b6b; }
        .mandatory-indicator { color: #ff6b6b; font-weight: bold; }
        .profile-tag { display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 0.75em; margin-left: 5px; }
        .profile-initial { background: #e3f2fd; color: #1976d2; }
        .profile-monthly { background: #f3e5f5; color: #7b1fa2; }
        .performance-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; }
        .performance-positive { background: #d4edda; color: #155724; }
        .performance-neutral { background: #e2e3e5; color: #383d41; }
        .performance-negative { background: #f8d7da; color: #721c24; }
        .performance-summary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .performance-summary h3 { color: white; margin-bottom: 15px; font-size: 1.2em; }
        .performance-metric { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.2); }
        .performance-metric:last-child { border-bottom: none; }
        .performance-metric-label { font-weight: bold; }
        .performance-metric-value { font-size: 1.2em; font-weight: bold; }
        .yearly-projection { background: #f0f8ff; padding: 15px; border-radius: 6px; margin-top: 15px; border-left: 4px solid #0066cc; }
        .yearly-projection h4 { color: #0066cc; margin-bottom: 10px; }
        .projection-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        .projection-item { background: white; padding: 10px; border-radius: 4px; border-left: 3px solid #667eea; }
        .projection-item-label { font-size: 0.85em; color: #666; margin-bottom: 5px; }
        .projection-item-value { font-size: 1.2em; font-weight: bold; color: #667eea; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üéØ ODDO BHF Fund Allocation Tool</h1>
        <p>Professional Portfolio Management Solution - 2026</p>
        <p style="font-size: 0.85em; margin-top: 5px;">S√©lection d'investissements selon les recommandations ODDO BHF</p>
    </div>

    <div class="message" id="message"></div>

    <div class="content">
        <div class="section">
            <h2>üìä Configuration</h2>
            
            <div class="form-group">
                <label>Contract Type *</label>
                <select id="contractType" onchange="updateFunds()">
                    <option value="">-- Select Contract --</option>
                    <option value="fipavie-ingenierie">Fipavie Ing√©nierie</option>
                    <option value="fipavie-opportunites">Fipavie Opportunit√©s</option>
                    <option value="fipavie-expertises">Fipavie Expertises</option>
                    <option value="per-opportunites">PER Opportunit√©s</option>
                    <option value="premavenir-per">Premavenir PER</option>
                </select>
            </div>

            <h3>üí∞ Initial Funding (‚Ç¨)</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Amount *</label>
                    <input type="number" id="initialFunding" min="1500" step="100" placeholder="Minimum: ‚Ç¨1,500" />
                </div>
                <div class="form-group">
                    <label>Risk Profile *</label>
                    <select id="initialRiskProfile" onchange="updateInitialConstraints()">
                        <option value="">-- Select Profile --</option>
                        <option value="secure">üõ°Ô∏è Conservative</option>
                        <option value="moderate">‚öñÔ∏è Balanced</option>
                        <option value="dynamic">üìà Aggressive</option>
                    </select>
                </div>
            </div>

            <div id="initialConstraintsBox" class="constraints-box" style="display: none;">
                <h3>‚úÖ Initial Constraints</h3>
                <div id="initialConstraintsList"></div>
            </div>

            <h3>üìä Monthly Funding (‚Ç¨)</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Amount *</label>
                    <input type="number" id="monthlyFunding" min="150" step="50" placeholder="Minimum: ‚Ç¨150" />
                </div>
                <div class="form-group">
                    <label>Risk Profile *</label>
                    <select id="monthlyRiskProfile" onchange="updateMonthlyConstraints()">
                        <option value="">-- Select Profile --</option>
                        <option value="secure">üõ°Ô∏è Conservative</option>
                        <option value="moderate">‚öñÔ∏è Balanced</option>
                        <option value="dynamic">üìà Aggressive</option>
                    </select>
                </div>
            </div>

            <div id="monthlyConstraintsBox" class="constraints-box" style="display: none;">
                <h3>‚úÖ Monthly Constraints</h3>
                <div id="monthlyConstraintsList"></div>
            </div>

            <button class="btn-primary" onclick="calculate()">üìä Calculate Allocation</button>
            <button class="btn-secondary" onclick="reset()">üîÑ Reset</button>
        </div>

        <div class="section" id="resultsSection" style="display: none;">
            <h2>‚úÖ Results</h2>
            <div class="results">
                <div class="result-row">
                    <span class="result-label">Contract:</span>
                    <span class="result-value" id="summaryContract">-</span>
                </div>
                <div class="result-row">
                    <span class="result-label">Initial Funding:</span>
                    <span class="result-value" id="summaryInitial">-</span>
                    <span class="profile-tag profile-initial" id="summaryInitialProfile"></span>
                </div>
                <div class="result-row">
                    <span class="result-label">Monthly Funding:</span>
                    <span class="result-value" id="summaryMonthly">-</span>
                    <span class="profile-tag profile-monthly" id="summaryMonthlyProfile"></span>
                </div>
            </div>
            <button class="btn-success" onclick="savePortfolio()">üíæ Save Portfolio</button>
            <button class="btn-success" style="background: #17a2b8; margin-top: 8px;" onclick="exportCSV()">üì• Export CSV</button>
        </div>
    </div>

    <div class="table-section" id="initialTableSection">
        <div class="table-header">üí∞ Initial Allocation (5-10 Funds)</div>
        <div class="performance-summary" id="initialPerformanceSummary"></div>
        <div id="initialWarning" class="allocation-warning" style="display: none; margin-top: -1px;"></div>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Fund Name</th>
                        <th>ISIN</th>
                        <th>Amount (‚Ç¨)</th>
                        <th>% of Portfolio</th>
                        <th>Risk Level</th>
                        <th>Geographic Focus</th>
                        <th>ESG Classification</th>
                        <th>1Y Performance</th>
                        <th>Strategy</th>
                    </tr>
                </thead>
                <tbody id="initialBody"></tbody>
            </table>
        </div>
    </div>

    <div class="table-section" id="monthlyTableSection">
        <div class="table-header">üìä Monthly Allocation (3+ Funds, ‚Ç¨50 min/fund)</div>
        <div class="performance-summary" id="monthlyPerformanceSummary"></div>
        <div id="monthlyWarning" class="allocation-warning" style="display: none; margin-top: -1px;"></div>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Fund Name</th>
                        <th>ISIN</th>
                        <th>Amount (‚Ç¨)</th>
                        <th>% of Portfolio</th>
                        <th>Risk Level</th>
                        <th>Geographic Focus</th>
                        <th>ESG Classification</th>
                        <th>1Y Performance</th>
                        <th>Strategy</th>
                    </tr>
                </thead>
                <tbody id="monthlyBody"></tbody>
            </table>
        </div>
    </div>

    <div class="footer">
        <p>¬© 2026 ODDO BHF Asset Management | Professional Edition v2.2</p>
        <p>For Professional Use Only | Document confidentiel distributeurs</p>
    </div>
</div>

<script>
    // PROFILE-BASED ALLOCATION CONSTRAINTS (Fixed Minimums/Maximums)
    const profileConstraints = {
        secure: {
            name: 'Conservative (Secure)',
            constraints: [
                { type: 'Bonds & Fixed Income', max: 60, min: 50 },
                { type: 'Equities', max: 20, min: 10 },
                { type: 'Mixed Assets', max: 15, min: 5 },
                { type: 'Alternatives', max: 5, min: 0 }
            ],
            mandatory: [
                { fundId: 'fund-securite-infra', minPercent: 10, label: 'S√©curit√© Infra Euro (min 10%)' },
                { fundId: 'fund-securite-euro', minPercent: 10, label: 'S√©curit√© en Euros (min 10%, when eligible)' }
            ]
        },
        moderate: {
            name: 'Balanced (Moderate)',
            constraints: [
                { type: 'Bonds & Fixed Income', max: 40, min: 30 },
                { type: 'Equities', max: 50, min: 40 },
                { type: 'Mixed Assets', max: 10, min: 5 },
                { type: 'Alternatives', max: 5, min: 0 }
            ],
            mandatory: [
                { fundId: 'fund-securite-infra', minPercent: 10, label: 'S√©curit√© Infra Euro (min 10%)' }
            ]
        },
        dynamic: {
            name: 'Aggressive (Dynamic)',
            constraints: [
                { type: 'Equities', max: 100, min: 80 },
                { type: 'Fixed Income', max: 20, min: 0 },
                { type: 'Alternatives', max: 10, min: 0 }
            ],
            mandatory: []
        }
    };

    // ODDO BHF Recommended Funds - Enhanced with ISIN, Geographic Focus, ESG, and Performance
    const funds = [
        // MANDATORY FUNDS FOR CONSERVATIVE & MODERATE
        { fundId: 'fund-securite-infra', name: 'ODDO BHF S√©curit√© Infra Euro', isin: 'LU0876266276', riskLevel: 'Low', assetClass: 'Fixed Income', assetType: 'Bonds & Fixed Income', category: 'MANDATORY', allocation: 0.10, geographicFocus: 'Europe', esgClassification: 'High', performance1Y: 2.85, isMandatory: true },
        { fundId: 'fund-securite-euro', name: 'ODDO BHF S√©curit√© en Euros', isin: 'LU0268403865', riskLevel: 'Low', assetClass: 'Fixed Income', assetType: 'Bonds & Fixed Income', category: 'MANDATORY', allocation: 0.10, geographicFocus: 'Europe', esgClassification: 'High', performance1Y: 2.45, isMandatory: true },
        
        // INCONTOURNABLE - Essential
        { fundId: 'fund-nav', name: 'ODDO BHF Global Navigator', isin: 'LU0568438842', riskLevel: 'Medium', assetClass: 'Diversified', assetType: 'Mixed Assets', category: 'INCONTOURNABLE', allocation: 0.25, geographicFocus: 'Global', esgClassification: 'High', performance1Y: 5.32 },
        { fundId: 'fund-ia', name: 'ODDO BHF Artificial Intelligence', isin: 'LU1803984285', riskLevel: 'High', assetClass: 'Equity', assetType: 'Equities', category: 'INCONTOURNABLE', allocation: 0.20, geographicFocus: 'Global', esgClassification: 'High', performance1Y: 8.75 },
        { fundId: 'fund-ger', name: 'ODDO BHF German Equities', isin: 'LU0502241003', riskLevel: 'High', assetClass: 'Equity', assetType: 'Equities', category: 'INCONTOURNABLE', allocation: 0.18, geographicFocus: 'Europe', esgClassification: 'Medium', performance1Y: 6.42 },
        
        // STRAT√âGIQUE - Strategic
        { fundId: 'fund-metro', name: 'ODDO BHF M√©tropole Euro', isin: 'LU0211427521', riskLevel: 'Medium', assetClass: 'Equity', assetType: 'Equities', category: 'STRATEGIQUE', allocation: 0.20, geographicFocus: 'Europe', esgClassification: 'High', performance1Y: 4.18 },
        { fundId: 'fund-china', name: 'ODDO BHF China Equity Stars', isin: 'LU0697003994', riskLevel: 'High', assetClass: 'Equity', assetType: 'Equities', category: 'STRATEGIQUE', allocation: 0.18, geographicFocus: 'Asia', esgClassification: 'Medium', performance1Y: 7.56 },
        
        // PORTAGE - Carry Trade / Fixed Income
        { fundId: 'fund-target', name: 'ODDO BHF Global Target 2031', isin: 'LU1598873842', riskLevel: 'Medium', assetClass: 'Fixed Income', assetType: 'Mixed Assets', category: 'PORTAGE', allocation: 0.20, geographicFocus: 'Global', esgClassification: 'Medium', performance1Y: 3.64 },
        
        // COUP DE C≈íUR - Favorites
        { fundId: 'fund-credit', name: 'ODDO BHF Euro Credit Short Duration', isin: 'LU0410170084', riskLevel: 'Low', assetClass: 'Fixed Income', assetType: 'Bonds & Fixed Income', category: 'COUP', allocation: 0.15, geographicFocus: 'Europe', esgClassification: 'High', performance1Y: 2.75 },
        { fundId: 'fund-algo', name: 'ODDO BHF Algo Trend US', isin: 'LU0913291672', riskLevel: 'High', assetClass: 'Equity', assetType: 'Equities', category: 'COUP', allocation: 0.18, geographicFocus: 'North America', esgClassification: 'Medium', performance1Y: 9.12 },
        { fundId: 'fund-small', name: 'ODDO BHF Active Small Cap', isin: 'LU0501210403', riskLevel: 'High', assetClass: 'Equity', assetType: 'Equities', category: 'COUP', allocation: 0.16, geographicFocus: 'Europe', esgClassification: 'Medium', performance1Y: 5.89 },
        
        // Additional supporting funds
        { fundId: 'fund-avenir', name: 'ODDO BHF Avenir Europe', isin: 'LU0212090670', riskLevel: 'Medium', assetClass: 'Equity', assetType: 'Equities', category: 'SUPPORT', allocation: 0.17, geographicFocus: 'Europe', esgClassification: 'High', performance1Y: 6.34 },
        { fundId: 'fund-polaris', name: 'ODDO BHF Polaris Balanced', isin: 'LU0789568872', riskLevel: 'Medium', assetClass: 'Diversified', assetType: 'Mixed Assets', category: 'SUPPORT', allocation: 0.18, geographicFocus: 'Global', esgClassification: 'High', performance1Y: 4.76 },
        { fundId: 'fund-moderate', name: 'ODDO BHF Polaris Moderate', isin: 'LU0789568780', riskLevel: 'Low', assetClass: 'Diversified', assetType: 'Mixed Assets', category: 'SUPPORT', allocation: 0.15, geographicFocus: 'Global', esgClassification: 'High', performance1Y: 3.21 }
    ];

    const contracts = {
        'fipavie-ingenierie': { name: 'Fipavie Ing√©nierie', funds: { secure: ['fund-securite-infra', 'fund-securite-euro', 'fund-nav', 'fund-target', 'fund-credit', 'fund-moderate', 'fund-polaris'], moderate: ['fund-securite-infra', 'fund-nav', 'fund-metro', 'fund-avenir', 'fund-polaris', 'fund-target'], dynamic: ['fund-ia', 'fund-ger', 'fund-algo', 'fund-small', 'fund-metro', 'fund-china'] } },
        'fipavie-opportunites': { name: 'Fipavie Opportunit√©s', funds: { secure: ['fund-securite-infra', 'fund-securite-euro', 'fund-credit', 'fund-target', 'fund-moderate', 'fund-nav'], moderate: ['fund-securite-infra', 'fund-metro', 'fund-avenir', 'fund-polaris', 'fund-nav', 'fund-credit'], dynamic: ['fund-ia', 'fund-ger', 'fund-algo', 'fund-china', 'fund-small'] } },
        'fipavie-expertises': { name: 'Fipavie Expertises', funds: { secure: ['fund-securite-infra', 'fund-securite-euro', 'fund-credit', 'fund-target', 'fund-moderate'], moderate: ['fund-securite-infra', 'fund-metro', 'fund-polaris', 'fund-nav', 'fund-avenir'], dynamic: ['fund-ia', 'fund-ger', 'fund-algo', 'fund-china'] } },
        'per-opportunites': { name: 'PER Opportunit√©s', funds: { secure: ['fund-securite-infra', 'fund-securite-euro', 'fund-credit', 'fund-target', 'fund-moderate'], moderate: ['fund-securite-infra', 'fund-metro', 'fund-polaris', 'fund-nav'], dynamic: ['fund-ia', 'fund-ger', 'fund-algo', 'fund-small'] } },
        'premavenir-per': { name: 'Premavenir PER', funds: { secure: ['fund-securite-infra', 'fund-credit', 'fund-moderate'], moderate: ['fund-securite-infra', 'fund-metro', 'fund-polaris'], dynamic: ['fund-ia', 'fund-ger', 'fund-algo'] } }
    };

    let currentAllocation = null;

    function updateFunds() {
        console.log('Contract selected');
    }

    function displayConstraints(profileType, constraintListId) {
        const profile = profileType === 'initial' ? document.getElementById('initialRiskProfile').value : document.getElementById('monthlyRiskProfile').value;
        const constraintsBox = document.getElementById(profileType === 'initial' ? 'initialConstraintsBox' : 'monthlyConstraintsBox');
        const constraintsList = document.getElementById(constraintListId);

        if (!profile) {
            constraintsBox.style.display = 'none';
            return;
        }

        const constraints = profileConstraints[profile];
        constraintsList.innerHTML = '';

        // Display asset class constraints
        constraints.constraints.forEach(constraint => {
            const item = document.createElement('div');
            item.className = 'constraint-item';
            item.innerHTML = `<strong>${constraint.type}:</strong> Min ${constraint.min}% - Max ${constraint.max}%`;
            constraintsList.appendChild(item);
        });

        // Display mandatory funds
        if (constraints.mandatory.length > 0) {
            const mandatoryTitle = document.createElement('div');
            mandatoryTitle.className = 'constraint-item';
            mandatoryTitle.style.marginTop = '10px';
            mandatoryTitle.style.fontWeight = 'bold';
            mandatoryTitle.style.color = '#ff6b6b';
            mandatoryTitle.innerHTML = 'üîí Mandatory Allocations:';
            constraintsList.appendChild(mandatoryTitle);

            constraints.mandatory.forEach(mandatory => {
                const item = document.createElement('div');
                item.className = 'constraint-item';
                item.style.marginLeft = '10px';
                item.innerHTML = `<strong style="color: #ff6b6b;">‚Üí ${mandatory.label}</strong>`;
                constraintsList.appendChild(item);
            });
        }

        constraintsBox.style.display = 'block';
    }

    function updateInitialConstraints() {
        displayConstraints('initial', 'initialConstraintsList');
    }

    function updateMonthlyConstraints() {
        displayConstraints('monthly', 'monthlyConstraintsList');
    }

    function getCategoryBadge(category) {
        switch(category) {
            case 'INCONTOURNABLE': return '<span class="recommendation-badge badge-incontournable">‚≠ê Incontournable</span>';
            case 'STRATEGIQUE': return '<span class="recommendation-badge badge-strategique">üìä Strat√©gique</span>';
            case 'PORTAGE': return '<span class="recommendation-badge badge-portage">üí∞ Portage</span>';
            case 'COUP': return '<span class="recommendation-badge badge-coup">‚ù§Ô∏è Coup de c≈ìur</span>';
            case 'MANDATORY': return '<span class="recommendation-badge" style="background: #ff6b6b; color: white;">üîí Mandatory</span>';
            default: return '<span class="recommendation-badge" style="background: #ddd; color: #333;">üìå Support</span>';
        }
    }

    function getRiskBadgeClass(riskLevel) {
        switch(riskLevel.toLowerCase()) {
            case 'low': return 'badge-low';
            case 'medium': return 'badge-medium';
            case 'high': return 'badge-high';
            case 'very high': return 'badge-very-high';
            default: return 'badge-medium';
        }
    }

    function getESGBadgeClass(esg) {
        switch(esg.toLowerCase()) {
            case 'high': return 'esg-high';
            case 'medium': return 'esg-medium';
            case 'low': return 'esg-low';
            default: return 'esg-medium';
        }
    }

    function getPerformanceBadgeClass(performance) {
        if (performance >= 7) return 'performance-positive';
        if (performance >= 4) return 'performance-neutral';
        return 'performance-negative';
    }

    function formatPerformance(performance) {
        return performance.toFixed(2) + '%';
    }

    function calculate() {
        const contractId = document.getElementById('contractType').value;
        const initialProfile = document.getElementById('initialRiskProfile').value;
        const monthlyProfile = document.getElementById('monthlyRiskProfile').value;
        const initialFunding = parseFloat(document.getElementById('initialFunding').value);
        const monthlyFunding = parseFloat(document.getElementById('monthlyFunding').value);

        if (!contractId || !initialProfile || !monthlyProfile || isNaN(initialFunding) || initialFunding < 1500 || isNaN(monthlyFunding) || monthlyFunding < 150) {
            showMsg('‚ùå Please fill all fields with valid values', 'error');
            return;
        }

        const contract = contracts[contractId];
        
        // Get funds for each profile
        const initialFundIds = contract.funds[initialProfile];
        const monthlyFundIds = contract.funds[monthlyProfile];
        
        const initialSelectedFunds = funds.filter(f => initialFundIds.includes(f.fundId));
        const monthlySelectedFunds = funds.filter(f => monthlyFundIds.includes(f.fundId));

        // Calculate allocations with mandatory constraints
        const initialAllocation = allocateFundsWithConstraints(initialSelectedFunds, initialFunding, initialProfile, 5, 10);
        const monthlyAllocation = allocateFundsWithConstraints(monthlySelectedFunds, monthlyFunding, monthlyProfile, 3, monthlySelectedFunds.length, 50);

        if (!initialAllocation || !monthlyAllocation) {
            showMsg('‚ùå Unable to allocate funds while respecting profile constraints', 'error');
            return;
        }

        currentAllocation = {
            contractId,
            initialProfile,
            monthlyProfile,
            initialFunding,
            monthlyFunding,
            initialAllocation,
            monthlyAllocation
        };

        displayResults(contract, initialProfile, monthlyProfile, initialFunding, monthlyFunding, initialAllocation, monthlyAllocation);
        showMsg('‚úÖ Allocation calculated successfully respecting all constraints!', 'success');
    }

    function allocateFundsWithConstraints(fundsList, totalAmount, profile, minFunds, maxFunds, minPerFund = 50) {
        let allocations = [];
        const constraints = profileConstraints[profile];
        const mandatoryFunds = constraints.mandatory;
        
        // First, allocate mandatory funds
        const mandatoryAllocations = [];
        let remainingAmount = totalAmount;
        
        mandatoryFunds.forEach(mandatory => {
            const fundData = fundsList.find(f => f.fundId === mandatory.fundId);
            if (fundData) {
                const mandatoryAmount = Math.floor((mandatory.minPercent / 100) * totalAmount);
                mandatoryAllocations.push({
                    ...fundData,
                    calculatedAmount: mandatoryAmount,
                    percentage: mandatory.minPercent,
                    isMandatory: true
                });
                remainingAmount -= mandatoryAmount;
            }
        });

        // Then allocate remaining funds
        const nonMandatoryFunds = fundsList.filter(f => !mandatoryFunds.some(m => m.fundId === f.fundId));
        const numFunds = Math.min(maxFunds, Math.max(minFunds, Math.ceil(nonMandatoryFunds.length / 2)));
        const selectedFundsList = nonMandatoryFunds.slice(0, numFunds - mandatoryAllocations.length);
        
        const amountPerFund = Math.floor(remainingAmount / selectedFundsList.length / 50) * 50;
        
        selectedFundsList.forEach(fund => {
            if (amountPerFund >= minPerFund) {
                allocations.push({
                    ...fund,
                    calculatedAmount: amountPerFund
                });
            }
        });

        const totalAllocated = allocations.reduce((a, b) => a + b.calculatedAmount, 0) + mandatoryAllocations.reduce((a, b) => a + b.calculatedAmount, 0);
        const remainder = totalAmount - totalAllocated;
        
        if (remainder >= minPerFund && allocations.length > 0) {
            allocations[0].calculatedAmount += remainder;
        } else if (remainder >= minPerFund && mandatoryAllocations.length > 0) {
            mandatoryAllocations[0].calculatedAmount += remainder;
        }

        // Combine all allocations
        const allAllocations = [...mandatoryAllocations, ...allocations];
        
        // Calculate percentages
        const allAllocationsWithPercentages = allAllocations.map(alloc => ({
            ...alloc,
            percentage: (alloc.calculatedAmount / totalAmount) * 100
        }));

        return allAllocationsWithPercentages;
    }

    function calculateWeightedPerformance(allocation) {
        return allocation.reduce((sum, fund) => {
            return sum + (fund.performance1Y * (fund.percentage / 100));
        }, 0);
    }

    function calculateProjectedValue(initialAmount, performance, years = 1) {
        return initialAmount * Math.pow((1 + performance / 100), years);
    }

    function createPerformanceSummary(allocation, totalAmount) {
        const avgPerformance = calculateWeightedPerformance(allocation);
        const projectedValue1Y = calculateProjectedValue(totalAmount, avgPerformance, 1);
        const projectedGain1Y = projectedValue1Y - totalAmount;
        const projectedValue5Y = calculateProjectedValue(totalAmount, avgPerformance, 5);
        const projectedGain5Y = projectedValue5Y - totalAmount;

        let html = `
            <div class="performance-metric">
                <span class="performance-metric-label">üìä Portfolio Weighted Average Performance (1Y):</span>
                <span class="performance-metric-value" style="color: #fff;">${avgPerformance.toFixed(2)}%</span>
            </div>
            <div class="performance-metric">
                <span class="performance-metric-label">üí∞ Projected Value (1 Year):</span>
                <span class="performance-metric-value" style="color: #4ec74e;">‚Ç¨${projectedValue1Y.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
            </div>
            <div class="performance-metric">
                <span class="performance-metric-label">üìà Projected Gain (1 Year):</span>
                <span class="performance-metric-value" style="color: #4ec74e;">‚Ç¨${projectedGain1Y.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
            </div>
            <div class="yearly-projection">
                <h4>üìÖ Multi-Year Projections</h4>
                <div class="projection-row">
                    <div class="projection-item">
                        <div class="projection-item-label">1 Year</div>
                        <div class="projection-item-value">‚Ç¨${projectedValue1Y.toLocaleString('de-DE', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                    </div>
                    <div class="projection-item">
                        <div class="projection-item-label">3 Years</div>
                        <div class="projection-item-value">‚Ç¨${calculateProjectedValue(totalAmount, avgPerformance, 3).toLocaleString('de-DE', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                    </div>
                    <div class="projection-item">
                        <div class="projection-item-label">5 Years</div>
                        <div class="projection-item-value">‚Ç¨${projectedValue5Y.toLocaleString('de-DE', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                    </div>
                    <div class="projection-item">
                        <div class="projection-item-label">10 Years</div>
                        <div class="projection-item-value">‚Ç¨${calculateProjectedValue(totalAmount, avgPerformance, 10).toLocaleString('de-DE', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                    </div>
                </div>
            </div>
        `;
        return html;
    }

    function displayResults(contract, initialProfile, monthlyProfile, initialFunding, monthlyFunding, initialAllocation, monthlyAllocation) {
        document.getElementById('resultsSection').style.display = 'block';
        document.getElementById('summaryContract').textContent = contract.name;
        document.getElementById('summaryInitial').textContent = `‚Ç¨${initialFunding.toLocaleString('de-DE')}`;
        document.getElementById('summaryInitialProfile').textContent = profileConstraints[initialProfile].name;
        document.getElementById('summaryMonthly').textContent = `‚Ç¨${monthlyFunding.toLocaleString('de-DE')}`;
        document.getElementById('summaryMonthlyProfile').textContent = profileConstraints[monthlyProfile].name;

        // Generate performance summaries
        document.getElementById('initialPerformanceSummary').innerHTML = createPerformanceSummary(initialAllocation, initialFunding);
        document.getElementById('monthlyPerformanceSummary').innerHTML = createPerformanceSummary(monthlyAllocation, monthlyFunding);

        displayTable('initialBody', initialAllocation, initialFunding);
        displayTable('monthlyBody', monthlyAllocation, monthlyFunding);

        document.getElementById('initialTableSection').classList.add('active');
        document.getElementById('monthlyTableSection').classList.add('active');
    }

    function displayTable(tableBodyId, allocations, totalAmount) {
        const tbody = document.getElementById(tableBodyId);
        tbody.innerHTML = '';

        allocations.forEach(fund => {
            const row = document.createElement('tr');
            if (fund.isMandatory) {
                row.className = 'mandatory-fund';
            }
            const riskClass = getRiskBadgeClass(fund.riskLevel);
            const esgClass = getESGBadgeClass(fund.esgClassification);
            const performanceClass = getPerformanceBadgeClass(fund.performance1Y);

            const mandatoryIndicator = fund.isMandatory ? '<span class="mandatory-indicator">üîí</span> ' : '';

            row.innerHTML = `
                <td>${mandatoryIndicator}${fund.name}</td>
                <td><code style="background: #f0f0f0; padding: 2px 4px; border-radius: 3px; font-size: 0.85em;">${fund.isin}</code></td>
                <td>‚Ç¨${fund.calculatedAmount.toLocaleString('de-DE')}</td>
                <td><strong>${fund.percentage.toFixed(1)}%</strong></td>
                <td><span class="badge ${riskClass}">${fund.riskLevel}</span></td>
                <td><span class="geo-badge">${fund.geographicFocus}</span></td>
                <td><span class="esg-badge ${esgClass}">${fund.esgClassification}</span></td>
                <td><span class="performance-badge ${performanceClass}"><strong>${formatPerformance(fund.performance1Y)}</strong></span></td>
                <td>${getCategoryBadge(fund.category)}</td>
            `;
            tbody.appendChild(row);
        });

        // Total row
        const totalRow = document.createElement('tr');
        totalRow.style.background = '#f0f0f0';
        totalRow.style.fontWeight = 'bold';
        totalRow.style.borderTop = '2px solid #667eea';
        const totalPercent = allocations.reduce((sum, f) => sum + f.percentage, 0);
        const avgPerformance = calculateWeightedPerformance(allocations);
        totalRow.innerHTML = `
            <td colspan="2">TOTAL ALLOCATION</td>
            <td>‚Ç¨${totalAmount.toLocaleString('de-DE')}</td>
            <td><strong>${totalPercent.toFixed(1)}%</strong></td>
            <td colspan="2"></td>
            <td colspan="1"></td>
            <td><span class="performance-badge" style="background: #667eea; color: white;"><strong>${formatPerformance(avgPerformance)}</strong></span></td>
            <td></td>
        `;
        tbody.appendChild(totalRow);
    }

    function savePortfolio() {
        if (!currentAllocation) {
            showMsg('‚ùå No allocation to save', 'error');
            return;
        }
        showMsg('‚úÖ Portfolio saved successfully!', 'success');
        setTimeout(() => reset(), 1500);
    }

    function exportCSV() {
        if (!currentAllocation) {
            showMsg('‚ùå No allocation to export', 'error');
            return;
        }

        const initialAvgPerf = calculateWeightedPerformance(currentAllocation.initialAllocation);
        const monthlyAvgPerf = calculateWeightedPerformance(currentAllocation.monthlyAllocation);

        let csv = 'ODDO BHF Fund Allocation Report\n';
        csv += `Generated: ${new Date().toLocaleDateString()}\n`;
        csv += `Contract: ${contracts[currentAllocation.contractId].name}\n\n`;

        csv += 'INITIAL ALLOCATION\n';
        csv += `Profile: ${profileConstraints[currentAllocation.initialProfile].name}\n`;
        csv += `Total Amount: ‚Ç¨${currentAllocation.initialFunding.toLocaleString('de-DE')}\n`;
        csv += `Portfolio Weighted Average Performance (1Y): ${initialAvgPerf.toFixed(2)}%\n`;
        csv += `Projected Value (1 Year): ‚Ç¨${calculateProjectedValue(currentAllocation.initialFunding, initialAvgPerf, 1).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n\n`;
        csv += 'Fund Name,ISIN,Amount (‚Ç¨),Percentage (%),Risk Level,Geographic Focus,ESG Classification,1Y Performance (%),Category,Mandatory\n';
        currentAllocation.initialAllocation.forEach(fund => {
            csv += `"${fund.name}","${fund.isin}",${fund.calculatedAmount},${fund.percentage.toFixed(1)},${fund.riskLevel},"${fund.geographicFocus}","${fund.esgClassification}",${fund.performance1Y.toFixed(2)},"${fund.category}","${fund.isMandatory ? 'YES' : 'NO'}"\n`;
        });

        csv += '\nMONTHLY ALLOCATION\n';
        csv += `Profile: ${profileConstraints[currentAllocation.monthlyProfile].name}\n`;
        csv += `Total Amount: ‚Ç¨${currentAllocation.monthlyFunding.toLocaleString('de-DE')}\n`;
        csv += `Portfolio Weighted Average Performance (1Y): ${monthlyAvgPerf.toFixed(2)}%\n`;
        csv += `Projected Value (1 Year): ‚Ç¨${calculateProjectedValue(currentAllocation.monthlyFunding, monthlyAvgPerf, 1).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n\n`;
        csv += 'Fund Name,ISIN,Amount (‚Ç¨),Percentage (%),Risk Level,Geographic Focus,ESG Classification,1Y Performance (%),Category,Mandatory\n';
        currentAllocation.monthlyAllocation.forEach(fund => {
            csv += `"${fund.name}","${fund.isin}",${fund.calculatedAmount},${fund.percentage.toFixed(1)},${fund.riskLevel},"${fund.geographicFocus}","${fund.esgClassification}",${fund.performance1Y.toFixed(2)},"${fund.category}","${fund.isMandatory ? 'YES' : 'NO'}"\n`;
        });

        const element = document.createElement('a');
        element.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv));
        element.setAttribute('download', `ODDO_BHF_Allocation_${Date.now()}.csv`);
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);

        showMsg('‚úÖ Report exported as CSV!', 'success');
    }

    function reset() {
        document.getElementById('contractType').value = '';
        document.getElementById('initialRiskProfile').value = '';
        document.getElementById('monthlyRiskProfile').value = '';
        document.getElementById('initialFunding').value = '';
        document.getElementById('monthlyFunding').value = '';
        document.getElementById('resultsSection').style.display = 'none';
        document.getElementById('initialConstraintsBox').style.display = 'none';
        document.getElementById('monthlyConstraintsBox').style.display = 'none';
        document.getElementById('initialTableSection').classList.remove('active');
        document.getElementById('monthlyTableSection').classList.remove('active');
        currentAllocation = null;
    }

    function showMsg(message, type) {
        const msgElement = document.getElementById('message');
        msgElement.textContent = message;
        msgElement.className = `message show ${type}`;
        setTimeout(() => msgElement.classList.remove('show'), 4000);
    }
</script>

</body>
</html>
